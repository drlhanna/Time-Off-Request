<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Off Requests</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGltZSBPZmYgUmVxdWVzdHMiLCJzaG9ydF9uYW1lIjoiVGltZSBPZmYiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwN0FGRiIsInRoZW1lX2NvbG9yIjoiIzAwN0FGRiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTV6TXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSmhkWFJ2SWlCb1pXbG5hSFE5SW1GMWRHOGlJSFpwWlhkQ2IzZzlJakFnTUNBeU5EQWdNalF3SWo0OFkyUnlZM1JsUGp4d1lYUm9JR1E5SW0wNE1DQXhNakJzTkRBZ05EQXROREFnTkRBdE5EQXROREJhVFRnMElERTJZekkwSURBZ05EUWdNVFlnTkRRZ05EQnNNQ0ExTmkwME5pNDJOQ0F6TWkwNE1uVjNNaTR6TkRNdElqNENQRkJoZEdnaVpEMGlUVGd3SURrMll5MHlOQzR4TmpVdE1USTFMbUoyU3pNdE1Ua3VNamczTFRjdE1UY3VOelZ6TnlBM1MwZ3hNRE03SWo0OEwzTjJaejQ9IiwiaWYiOjE5MiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Time Off Requests">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .company-logo {
            height: 60px;
            width: auto;
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .company-info {
            text-align: center;
        }
        
        .company-address {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 68px;
            z-index: 99;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 122, 255, 0.3);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .request-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .employee-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }
        
        .request-details {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-approve {
            background: linear-gradient(135deg, #28a745, #20c997);
            flex: 1;
        }
        
        .btn-deny {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            flex: 1;
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }
        
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .hidden {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .pto-disclaimer {
            background: #f8f9fa;
            border-left: 4px solid #007AFF;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 14px;
            color: #495057;
            line-height: 1.5;
        }
        
        .pto-disclaimer h4 {
            color: #007AFF;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .hours-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .hours-input {
            width: 100px !important;
            text-align: center;
        }
        
        .hours-buttons {
            display: flex;
            gap: 5px;
        }
        
        .hours-btn {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
        }
        
        .hours-btn:hover {
            background: #e9ecef;
            transform: none;
            box-shadow: none;
        }
        
        @media (max-width: 600px) {
            .admin-actions {
                flex-direction: column;
            }
            
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 12px 8px;
            }
            
            .hours-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .hours-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .header-logo {
                flex-direction: column;
                gap: 10px;
            }
            
            .company-logo {
                height: 50px;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <div style="height: 60px; width: 120px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #007AFF; font-weight: bold;">
                    COMPANY LOGO
                </div>
                <div class="company-info">
                    <div class="company-address">
                        61 Fourth Street<br>
                        Stamford, CT 06905<br>
                        Phone: (203) 348-3756
                    </div>
                </div>
            </div>
            <h1>⏰ Time Off Requests</h1>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('request')">📝 New Request</button>
            <button class="tab" onclick="showTab('list')">📋 My Requests</button>
            <button class="tab" id="adminTab" onclick="showTab('admin')" style="display: none;">👑 Admin</button>
            <button class="tab" onclick="showTab('settings')">⚙️ Settings</button>
        </div>
        
        <!-- New Request Tab -->
        <div id="request" class="tab-content active">
            <form id="requestForm">
                <div class="form-group">
                    <label for="employeeName">Full Name *</label>
                    <input type="text" id="employeeName" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeEmail">Email Address *</label>
                    <input type="email" id="employeeEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="startDate">Start Date *</label>
                    <input type="date" id="startDate" required>
                </div>
                
                <div class="form-group">
                    <label for="endDate">End Date *</label>
                    <input type="date" id="endDate" required>
                </div>
                
                <div class="form-group">
                    <label for="ptoHours">PTO Hours Requested *</label>
                    <div class="hours-selector">
                        <input type="number" id="ptoHours" class="hours-input" min="0" step="8" value="8" required>
                        <span>hours</span>
                    </div>
                    <div class="hours-buttons">
                        <button type="button" class="hours-btn" onclick="setPTOHours(8)">8 hrs</button>
                        <button type="button" class="hours-btn" onclick="setPTOHours(16)">16 hrs</button>
                        <button type="button" class="hours-btn" onclick="setPTOHours(24)">24 hrs</button>
                        <button type="button" class="hours-btn" onclick="setPTOHours(32)">32 hrs</button>
                        <button type="button" class="hours-btn" onclick="setPTOHours(40)">40 hrs</button>
                    </div>
                </div>
                
                <div class="pto-disclaimer">
                    <h4>⚠️ PTO Hours Policy</h4>
                    <p>PTO hours are accrued each pay period. PTO hours cannot exceed the hours that are accruable to you in a given year. If you have the PTO requested, it will be added to your next pay period. If not, it will be unpaid time off.</p>
                </div>
                
                <div class="form-group">
                    <label>Type of Time Off *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="vacation" name="timeOffType" value="Vacation" style="width: auto; margin-right: 10px;">
                            🏖️ Vacation
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="medical" name="timeOffType" value="Medical Appointment" style="width: auto; margin-right: 10px;">
                            🏥 Medical Appointment
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="illness" name="timeOffType" value="Illness" style="width: auto; margin-right: 10px;">
                            🤒 Illness
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="other" name="timeOffType" value="Other" style="width: auto; margin-right: 10px;">
                            📋 Other
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reason">Additional Details</label>
                    <textarea id="reason" rows="4" placeholder="Please provide any additional details about your time off request..."></textarea>
                </div>
                
                <button type="submit">Submit Request</button>
            </form>
        </div>
        
        <!-- My Requests Tab -->
        <div id="list" class="tab-content">
            <div id="requestsList"></div>
        </div>
        
        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <h2 style="margin-bottom: 20px;">Pending Approvals</h2>
            <div id="pendingRequests"></div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-section">
                <div class="settings-title">Admin Configuration</div>
                
                <div class="form-group">
                    <label for="adminEmail">Admin Email for Notifications</label>
                    <input type="email" id="adminEmail" placeholder="admin@company.com">
                </div>
                
                <button onclick="saveAdminEmail()" style="margin-bottom: 20px;">Save Admin Email</button>
                
                <div id="adminLoginSection">
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    <button onclick="adminLogin()">🔓 Login as Admin</button>
                </div>
                
                <div id="adminLoggedIn" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #d4edda; border-radius: 8px; margin: 10px 0;">
                        <span style="color: #155724;">✅ Logged in as Admin</span>
                        <button onclick="adminLogout()" style="width: auto; padding: 8px 16px; background: #dc3545;">Logout</button>
                    </div>
                </div>
                
                <div id="setupAdminSection" style="display: none;">
                    <h4 style="color: #856404; margin: 15px 0;">⚠️ First-time Admin Setup</h4>
                    <div class="form-group">
                        <label for="newAdminPassword">Create Admin Password</label>
                        <input type="password" id="newAdminPassword" placeholder="Create a secure password">
                    </div>
                    <div class="form-group">
                        <label for="confirmAdminPassword">Confirm Password</label>
                        <input type="password" id="confirmAdminPassword" placeholder="Confirm password">
                    </div>
                    <button onclick="setupAdmin()">🔒 Set Admin Password</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">Calendar Integration</div>
                
                <div class="form-group">
                    <label>Calendar Service</label>
                    <select id="calendarService">
                        <option value="google">Google Calendar</option>
                        <option value="outlook">Outlook Calendar</option>
                        <option value="yahoo">Yahoo Calendar</option>
                        <option value="ics">Download ICS File (iOS/Mac)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="calendarName">Calendar Name (Optional)</label>
                    <input type="text" id="calendarName" placeholder="Company Time Off Calendar" value="Company Time Off Calendar">
                </div>
                
                <button onclick="saveCalendarSettings()">Save Calendar Settings</button>
                
                <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                    <strong>📱 iOS Setup Instructions:</strong><br>
                    1. When you approve requests, calendar events will open automatically<br>
                    2. For ICS files: Tap the file → "Add to Calendar" → Choose your calendar<br>
                    3. Events will appear in your iOS Calendar app
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">App Information</div>
                <p><strong>Version:</strong> 1.0.0</p>
                <p><strong>Install:</strong> Add this page to your home screen for the best experience!</p>
                <button onclick="installPWA()" id="installBtn" style="margin-top: 15px; display: none;">📱 Install App</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Modal -->
    <div id="alertOverlay" class="alert-overlay hidden"></div>
    <div id="alertModal" class="alert hidden">
        <h3 id="alertTitle">Alert</h3>
        <p id="alertMessage"></p>
        <button onclick="closeAlert()" style="margin-top: 20px; width: auto; padding: 10px 20px;">OK</button>
    </div>

    <script>
        // App State
        let requests = JSON.parse(localStorage.getItem('timeOffRequests') || '[]');
        let adminSettings = JSON.parse(localStorage.getItem('adminSettings') || '{"adminEmail": "", "isAdminMode": false, "adminPasswordHash": "", "calendarService": "google", "calendarName": "Company Time Off Calendar"}');
        let deferredPrompt;
        let isAdminLoggedIn = sessionStorage.getItem('adminSession') === 'true';

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            renderRequests();
            renderPendingRequests();
            checkAdminSession();
            
            // Set minimum dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
            
            // Add PTO hours validation
            document.getElementById('ptoHours').addEventListener('input', validatePTOHours);
        });

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    if (result.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // PTO Hours Functions
        function setPTOHours(hours) {
            document.getElementById('ptoHours').value = hours;
        }

        function validatePTOHours() {
            const ptoHours = parseInt(document.getElementById('ptoHours').value);
            if (ptoHours % 8 !== 0) {
                document.getElementById('ptoHours').value = Math.round(ptoHours / 8) * 8;
            }
            if (ptoHours < 0) {
                document.getElementById('ptoHours').value = 0;
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the clicked tab button
            const clickedTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
                tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)
            );
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
        }

        // Form Submission
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get selected time off types
            const checkboxes = document.querySelectorAll('input[name="timeOffType"]:checked');
            const timeOffTypes = Array.from(checkboxes).map(cb => cb.value);
            
            if (timeOffTypes.length === 0) {
                showAlert('Error', 'Please select at least one type of time off.');
                return;
            }
            
            const ptoHours = parseInt(document.getElementById('ptoHours').value);
            if (!ptoHours || ptoHours <= 0) {
                showAlert('Error', 'Please enter valid PTO hours (must be greater than 0).');
                return;
            }
            
            if (ptoHours % 8 !== 0) {
                showAlert('Error', 'PTO hours must be in increments of 8 hours.');
                return;
            }
            
            const formData = {
                id: Date.now().toString(),
                employeeName: document.getElementById('employeeName').value,
                employeeEmail: document.getElementById('employeeEmail').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                ptoHours: ptoHours,
                timeOffTypes: timeOffTypes,
                reason: document.getElementById('reason').value || '',
                dateSubmitted: new Date().toISOString().split('T')[0],
                status: 'pending'
            };
            
            // Validate dates
            if (new Date(formData.startDate) > new Date(formData.endDate)) {
                showAlert('Error', 'End date must be after start date');
                return;
            }
            
            // Add request
            requests.push(formData);
            saveData();
            
            // Send email notification
            sendAdminNotification(formData);
            
            // Clear form
            document.getElementById('requestForm').reset();
            document.querySelectorAll('input[name="timeOffType"]').forEach(cb => cb.checked = false);
            document.getElementById('ptoHours').value = 8;
            
            // Show success message
            showAlert('Success', 'Your time off request has been submitted and the admin has been notified.');
            
            // Refresh displays
            renderRequests();
            renderPendingRequests();
        });

        // Email Notification
        function sendAdminNotification(request) {
            if (!adminSettings.adminEmail) {
                console.log('No admin email configured');
                return;
            }
            
            const subject = `New Time Off Request - ${request.employeeName}`;
            const body = `A new time off request has been submitted:

Employee: ${request.employeeName}
Email: ${request.employeeEmail}
Start Date: ${new Date(request.startDate).toLocaleDateString()}
End Date: ${new Date(request.endDate).toLocaleDateString()}
PTO Hours Requested: ${request.ptoHours} hours
Type of Time Off: ${request.timeOffTypes.join(', ')}
Additional Details: ${request.reason || 'None provided'}

Please review and approve/deny this request in the time off app.`;
            
            // Create mailto link
            const mailtoLink = `mailto:${adminSettings.adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
        }

        // Render Functions
        function renderRequests() {
            const container = document.getElementById('requestsList');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>No requests yet</h3>
                        <p>Submit your first vacation request to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = requests.map(request => `
                <div class="request-card">
                    <div class="request-header">
                        <div class="employee-name">${request.employeeName}</div>
                        <div class="status-badge status-${request.status}">${request.status}</div>
                    </div>
                    <div class="request-details">📅 ${new Date(request.startDate).toLocaleDateString()} - ${new Date(request.endDate).toLocaleDateString()}</div>
                    <div class="request-details">📧 ${request.employeeEmail}</div>
                    <div class="request-details">⏰ ${request.ptoHours || 0} PTO hours</div>
                    <div class="request-details">🏷️ ${request.timeOffTypes ? request.timeOffTypes.join(', ') : request.reason}</div>
                    ${request.reason ? `<div class="request-details">📝 ${request.reason}</div>` : ''}
                    <div class="request-details">📤 Submitted: ${new Date(request.dateSubmitted).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function renderPendingRequests() {
            const container = document.getElementById('pendingRequests');
            const pendingRequests = requests.filter(r => r.status === 'pending');
            
            if (!isAdminLoggedIn) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔒</div>
                        <h3>Admin Login Required</h3>
                        <p>Please login as admin in Settings to view and approve requests.</p>
                    </div>
                `;
                return;
            }
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <h3>No pending requests</h3>
                        <p>All requests have been processed!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pendingRequests.map(request => `
                <div class="request-card">
                    <div class="request-header">
                        <div class="employee-name">${request.employeeName}</div>
                        <div class="status-badge status-${request.status}">${request.status}</div>
                    </div>
                    <div class="request-details">📧 ${request.employeeEmail}</div>
                    <div class="request-details">📅 ${new Date(request.startDate).toLocaleDateString()} - ${new Date(request.endDate).toLocaleDateString()}</div>
                    <div class="request-details">⏰ ${request.ptoHours || 0} PTO hours</div>
                    <div class="request-details">🏷️ ${request.timeOffTypes ? request.timeOffTypes.join(', ') : 'Legacy request'}</div>
                    ${request.reason ? `<div class="request-details">📝 ${request.reason}</div>` : ''}
                    <div class="request-details">📤 Submitted: ${new Date(request.dateSubmitted).toLocaleDateString()}</div>
                    
                    <div class="admin-actions">
                        <button class="btn-approve" onclick="updateRequestStatus('${request.id}', 'approved')">
                            ✅ Approve
                        </button>
                        <button class="btn-deny" onclick="updateRequestStatus('${request.id}', 'denied')">
                            ❌ Deny
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Admin Functions
        function updateRequestStatus(requestId, status) {
            // Check if user is logged in as admin
            if (!isAdminLoggedIn) {
                showAlert('Access Denied', 'You must be logged in as admin to approve/deny requests.');
                return;
            }
            
            const requestIndex = requests.findIndex(r => r.id === requestId);
            if (requestIndex !== -1) {
                requests[requestIndex].status = status;
                saveData();
                
                if (status === 'approved') {
                    addToCalendar(requests[requestIndex]);
                }
                
                renderRequests();
                renderPendingRequests();
                
                showAlert('Success', `Request has been ${status}.`);
            }
        }

        function addToCalendar(request) {
            const startDate = new Date(request.startDate);
            const endDate = new Date(request.endDate);
            endDate.setDate(endDate.getDate() + 1); // Add one day for all-day event
            
            const timeOffType = request.timeOffTypes ? request.timeOffTypes.join(', ') : 'Time Off';
            const eventTitle = `${request.employeeName} - ${timeOffType}`;
            const eventDetails = `Type: ${timeOffType}\nPTO Hours: ${request.ptoHours || 0} hours\nEmployee Email: ${request.employeeEmail}\nAdditional Details: ${request.reason || 'None provided'}\nApproved on: ${new Date().toLocaleDateString()}`;
            
            // Format dates for calendar URL (YYYYMMDD format)
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            };
            
            const startDateFormatted = formatDate(startDate);
            const endDateFormatted = formatDate(endDate);
            
            const calendarService = adminSettings.calendarService || 'google';
            
            let calendarUrl;
            
            switch (calendarService) {
                case 'google':
                    calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${startDateFormatted}/${endDateFormatted}&details=${encodeURIComponent(eventDetails)}&location=${encodeURIComponent('Company')}`;
                    break;
                    
                case 'outlook':
                    calendarUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(eventTitle)}&body=${encodeURIComponent(eventDetails)}&startdt=${startDate.toISOString()}&enddt=${endDate.toISOString()}&allday=true`;
                    break;
                    
                case 'yahoo':
                    calendarUrl = `https://calendar.yahoo.com/?v=60&view=d&type=20&title=${encodeURIComponent(eventTitle)}&st=${startDateFormatted}&dur=allday&desc=${encodeURIComponent(eventDetails)}`;
                    break;
                    
                case 'ics':
                    downloadICSFile(request, eventTitle, eventDetails, startDate, endDate);
                    return;
                    
                default:
                    calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${startDateFormatted}/${endDateFormatted}&details=${encodeURIComponent(eventDetails)}`;
            }
            
            // Open calendar in new tab/window
            window.open(calendarUrl, '_blank');
        }
        
        function downloadICSFile(request, title, details, startDate, endDate) {
            // Create ICS file content
            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Vacation App//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${request.id}-${Date.now()}@vacation-app.com
DTSTART;VALUE=DATE:${startDate.toISOString().slice(0, 10).replace(/-/g, '')}
DTEND;VALUE=DATE:${endDate.toISOString().slice(0, 10).replace(/-/g, '')}
SUMMARY:${title}
DESCRIPTION:${details.replace(/\n/g, '\\n')}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-P1D
DESCRIPTION:${request.employeeName} vacation starts tomorrow
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR`;
            
            // Create and download the file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `${request.employeeName}-vacation-${request.startDate}.ics`;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show instructions for iOS
            showAlert('Calendar File Downloaded', 'The calendar file has been downloaded. On iOS: Open the file, then tap "Add to Calendar" to import it into your iOS Calendar app.');
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('adminEmail').value = adminSettings.adminEmail || '';
            document.getElementById('calendarService').value = adminSettings.calendarService || 'google';
            document.getElementById('calendarName').value = adminSettings.calendarName || 'Company Time Off Calendar';
            checkAdminSetup();
        }

        function checkAdminSetup() {
            const setupSection = document.getElementById('setupAdminSection');
            const loginSection = document.getElementById('adminLoginSection');
            const loggedInSection = document.getElementById('adminLoggedIn');
            
            if (!adminSettings.adminPasswordHash) {
                // No admin password set - show setup
                setupSection.style.display = 'block';
                loginSection.style.display = 'none';
                loggedInSection.style.display = 'none';
            } else if (isAdminLoggedIn) {
                // Admin logged in
                setupSection.style.display = 'none';
                loginSection.style.display = 'none';
                loggedInSection.style.display = 'block';
                document.getElementById('adminTab').style.display = 'block';
            } else {
                // Admin password exists but not logged in
                setupSection.style.display = 'none';
                loginSection.style.display = 'block';
                loggedInSection.style.display = 'none';
                document.getElementById('adminTab').style.display = 'none';
            }
        }

        function checkAdminSession() {
            isAdminLoggedIn = sessionStorage.getItem('adminSession') === 'true';
            checkAdminSetup();
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function setupAdmin() {
            const password = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('Error', 'Passwords do not match.');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Error', 'Password must be at least 6 characters long.');
                return;
            }
            
            adminSettings.adminPasswordHash = await hashPassword(password);
            saveData();
            
            // Clear password fields
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('confirmAdminPassword').value = '';
            
            showAlert('Success', 'Admin password has been set successfully. You can now login as admin.');
            checkAdminSetup();
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (!password) {
                showAlert('Error', 'Please enter the admin password.');
                return;
            }
            
            const passwordHash = await hashPassword(password);
            
            if (passwordHash === adminSettings.adminPasswordHash) {
                isAdminLoggedIn = true;
                sessionStorage.setItem('adminSession', 'true');
                document.getElementById('adminPassword').value = '';
                checkAdminSetup();
                renderPendingRequests(); // Refresh admin view
                showAlert('Success', 'Successfully logged in as admin.');
            } else {
                showAlert('Error', 'Incorrect admin password.');
            }
        }

        function adminLogout() {
            isAdminLoggedIn = false;
            sessionStorage.removeItem('adminSession');
            checkAdminSetup();
            
            // If currently on admin tab, switch to list tab
            if (document.getElementById('admin').classList.contains('active')) {
                showTab('list');
                document.querySelector('[onclick="showTab(\'list\')"]').classList.add('active');
            }
            
            showAlert('Success', 'Successfully logged out.');
        }

        function saveAdminEmail() {
            const email = document.getElementById('adminEmail').value;
            adminSettings.adminEmail = email;
            saveData();
            showAlert('Success', 'Admin email has been saved successfully.');
        }

        function saveCalendarSettings() {
            adminSettings.calendarService = document.getElementById('calendarService').value;
            adminSettings.calendarName = document.getElementById('calendarName').value;
            saveData();
            showAlert('Success', 'Calendar settings have been saved successfully.');
        }

        // Utility Functions
        function saveData() {
            localStorage.setItem('timeOffRequests', JSON.stringify(requests));
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));
        }

        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertOverlay').classList.remove('hidden');
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('alertOverlay').classList.add('hidden');
            document.getElementById('alertModal').classList.add('hidden');
        }

        // Close alert when clicking overlay
        document.getElementById('alertOverlay').addEventListener('click', closeAlert);
    </script>
</body>
</html>
